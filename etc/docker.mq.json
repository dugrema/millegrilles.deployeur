{
  "Name": "mq",
  "TaskTemplate": {
    "ContainerSpec": {
      "Image": "${mq}",
      "Hostname": "mq.local",
      "Env": [
        "MG_KEY=/run/secrets/key.pem",
        "WEB_KEY=/run/secrets/webkey.pem"
      ],
      "Mounts": [
        {
          "Type": "volume",
          "Source": "mg-middleware-rabbitmq-data-${NOM_MILLEGRILLE}",
          "Target": "/var/lib/rabbitmq"
        },
        {
          "Type": "volume",
          "Source": "mq-accounts",
          "Target": "/opt/rabbitmq/conf"
        }
      ],
      "Secrets": [
        {
          "SecretName": "pki.mq.key",
          "File": {
            "Name": "key.pem",
            "UID": "0",
            "GID": "0",
            "Mode": 292
          }
        },
        {
          "SecretName": "pki.mq.key",
          "File": {
            "Name": "webkey.pem",
            "UID": "0",
            "GID": "0",
            "Mode": 292
          }
        }
      ],
      "Configs": [
        {
          "ConfigName": "pki.mq.cert",
          "File": {
            "Name": "/opt/rabbitmq/dist/certs/cert.pem",
            "UID": "0",
            "GID": "0",
            "Mode": 292
          }
        },
        {
          "ConfigName": "pki.ca.millegrille.fullchain",
          "File": {
            "Name": "/opt/rabbitmq/dist/certs/calist.cert.pem",
            "UID": "0",
            "GID": "0",
            "Mode": 292
          }
        },
        {
          "ConfigName": "pki.mq.cert",
          "File": {
            "Name": "/opt/rabbitmq/dist/certs/webcert.pem",
            "UID": "0",
            "GID": "0",
            "Mode": 292
          }
        }
      ]
    },
    "Placement": {
      "Constraints": [
        "node.labels.netzone.private == true",
        "node.labels.millegrilles.mq == true"
      ]
    },
    "Resources": {
      "Limits": {
        "NanoCPUs": 1000000000,
        "MemoryBytes": 629145600
      }
    },
    "RestartPolicy": {
      "Condition": "any",
      "Delay": 30000000000
    },
    "Mode": {
      "Replicated": {
        "Replicas": 1
      }
    },
    "Networks": [
        {
          "Target": "mg_${NOM_MILLEGRILLE}_net",
          "Aliases": ["mq", "mq.local"]
        }
    ]
  },
  "EndpointSpec": {
    "Mode": "vip",
    "Ports": [
      {
        "Protocol": "tcp",
        "PublishedPort": 8443,
        "TargetPort": 8443,
        "PublishMode": "host"
      },
      {
        "Protocol": "tcp",
        "PublishedPort": 5671,
        "TargetPort": 5671,
        "PublishMode": "host"
      },
      {
        "Protocol": "tcp",
        "PublishedPort": 5673,
        "TargetPort": 5673,
        "PublishMode": "host"
      }
    ]
  },
  "Labels": {
    "millegrille": "${NOM_MILLEGRILLE}"
  }
}
