{
  "Name": "nginx",
  "TaskTemplate": {
    "ContainerSpec": {
      "Image": "${nginx}",
      "Args": [
        "./run.sh"
      ],
      "Hostname": "${DOMAIN_PUBLIC}",
      "Env": [
        "NOM_MILLEGRILLE=${NOM_MILLEGRILLE}",
        "NGINX_CONFIG_FILE=millegrilles.conf",
        "WEB_CERT=/run/secrets/pki.millegrilles.web.fullchain",
        "WEB_KEY=/run/secrets/pki.millegrilles.web.key",
        "WEB_URL=${URL_WEB}",
        "WEB_COUPDOEIL=${URL_COUPDOEIL}",
        "LOCAL_CERT=/run/secrets/pki.millegrilles.ssl.fullchain",
        "LOCAL_KEY=/run/secrets/pki.millegrilles.ssl.key",
        "LOCAL_URL=mg-${NOM_MILLEGRILLE}.local",
        "LOCAL_COUPDOEIL=coupdoeil-${NOM_MILLEGRILLE}.local"
      ],
      "Mounts": [
        {
          "Type": "bind",
          "Source": "/opt/millegrilles/${NOM_MILLEGRILLE}/mounts/nginx",
          "Target": "/usr/share/nginx/html"
        }
      ],
      "Secrets": [
        {
          "SecretName": "pki.millegrilles.web.key;pki.nginx.key",
          "File": {
            "Name": "pki.millegrilles.web.key",
            "UID": "0",
            "GID": "0",
            "Mode": 292
          }
        },{
          "SecretName": "pki.nginx.key",
          "File": {
            "Name": "pki.millegrilles.ssl.key",
            "UID": "0",
            "GID": "0",
            "Mode": 292
          }
        }
      ],
      "Configs": [
        {
          "ConfigName": "pki.millegrilles.web.fullchain;pki.nginx.fullchain",
          "File": {
            "Name": "/run/secrets/pki.millegrilles.web.fullchain",
            "UID": "0",
            "GID": "0",
            "Mode": 292
          }
        },{
          "ConfigName": "pki.nginx.fullchain",
          "File": {
            "Name": "/run/secrets/pki.millegrilles.ssl.fullchain",
            "UID": "0",
            "GID": "0",
            "Mode": 292
          }
        }
      ]
    },
    "Placement": {
      "Constraints": [
        "node.labels.millegrilles.nginx == true"
      ]
    },
    "Resources": {
      "Limits": {
        "NanoCPUs": 500000000,
        "MemoryBytes": 52428800
      }
    },
    "RestartPolicy": {
      "Condition": "any",
      "Delay": 30000000000,
      "MaxAttempts": 10
    },
    "Mode": {
      "Replicated": {
        "Replicas": 1
      }
    },
    "Networks": [
        {
          "Target": "mg_${NOM_MILLEGRILLE}_net",
          "Aliases": ["www", "${DOMAIN_PUBLIC}", "mg-${NOM_MILLEGRILLE}.local"]
        }
    ]
  },
 "EndpointSpec": {
    "Mode": "vip",
    "Ports": [
      {
        "Protocol": "tcp",
        "PublishedPort": 443,
        "TargetPort": 443,
        "PublishMode": "host"
      },{
        "Protocol": "tcp",
        "PublishedPort": 80,
        "TargetPort": 80,
        "PublishMode": "host"
      }
    ]
  },
  "Labels": {
    "millegrille": "${NOM_MILLEGRILLE}"
  }
}
